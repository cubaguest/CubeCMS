var FileBrowserDialogue={listType:null,win:null,category:0,init:function(){FileBrowser.listType=tinyMCEPopup.getWindowArg("listType");FileBrowserDialogue.win=tinyMCEPopup.getWindowArg("window");FileBrowserDialogue.category=tinyMCEPopup.getWindowArg("cat");var c=tinyMCEPopup.getWindowArg("url");if(c!=""){var a=/data(\/.*\/)[a-z0-9._-]+/i;var b=c.match(a);if(b){FileBrowser.currentDir=b[1]}}FileBrowser.init()},submitFile:function(){FileBrowserDialogue.win.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=FileBrowser.getSelected().data("realpath");if(typeof(FileBrowserDialogue.win.ImageDialog)!="undefined"){if(FileBrowserDialogue.win.ImageDialog.getImageData){FileBrowserDialogue.win.ImageDialog.getImageData()}if(FileBrowserDialogue.win.ImageDialog.showPreviewImage){FileBrowserDialogue.win.ImageDialog.showPreviewImage(FileBrowser.getSelected().data("realpath"))}}tinyMCEPopup.close()}};var FileBrowser={cmsPluginUrl:null,currentDir:null,baseUrl:null,iconsDir:"images/files/",uploadLink:null,sessionId:null,listType:null,uploadFilesPosParams:null,$itemsBox:null,$dirCnt:null,writable:false,clipboard:{cut:false,items:new Array},extendJQ:function(){$.fn.selectItem=function(){$(this).addClass("item-selected")};$.fn.markItem=function(){$(this).addClass("item-marked")};$.fn.unselectItem=function(){$(this).removeClass("item-selected")};$.fn.unmarkItem=function(){$(this).removeClass("item-marked")};$.fn.clipCutItem=function(){$(this).addClass("item-cut")};$.fn.clipUncutItem=function(){$(this).removeClass("item-cut")};$.extend({isSelectedItem:function(a){return $(a).hasClass("item-selected")},isMarkedItem:function(a){return $(a).hasClass("item-marked")},getItemSize:function(a){var a=parseFloat(a);if(a>1048576){return Number(a/1048576).toFixed(2).toString()+" MB"}else{if(a>1024){return Number(a/1024).toFixed(2).toString()+" KB"}else{return a.toString()+" B"}}}})},init:function(){this.extendJQ();this.cmsPluginUrl=window.location.toString().replace("browser.php","jscripts/tinymce/");if(this.currentDir==null){if(openDir){this.currentDir=openDir}else{this.currentDir=this.loadPath()}}this.uploadFilesPosParams={sessionid:FileBrowser.sessionId,upload_send:"send",path:FileBrowser.currentDir,type:FileBrowser.listType};$(".swfupload-control").swfupload({upload_url:FileBrowser.uploadLink,file_post_name:"upload_file",post_params:FileBrowser.uploadFilesPosParams,file_size_limit:(maxUploadFileSize/1024),file_types:FileBrowser.getFileTypes(),file_types_description:"files",file_upload_limit:150,file_queue_limit:0,button_image_url:FileBrowser.baseUrl+"/images/upload_cs.png",button_placeholder_id:"spanButtonPlaceholder",button_width:61,button_height:22,button_window_mode:SWFUpload.WINDOW_MODE.OPAQUE,flash_url:FileBrowser.baseUrl+"/jscripts/swfupload/swfupload.swf",flash9_url:FileBrowser.baseUrl+"/jscripts/swfupload/swfupload_fp9.swf"});$(".swfupload-control").bind("fileQueued",function(b,a){FileBrowser.uploadFilesPosParams.path=FileBrowser.currentDir;$(this).swfupload("setPostParams",FileBrowser.uploadFilesPosParams);$(this).swfupload("startUpload")}).bind("uploadComplete",function(b,a){$(this).swfupload("startUpload")}).bind("uploadStart",function(b,a){$("#uploading-files").show()}).bind("fileQueueError",function(c,a,d,b){FileBrowser.showResult([],["Velikost souboru "+a.name+" je větší než povolený limit"])}).bind("uploadSuccess",function(c,b,a){FileBrowser.load();$("#uploading-files").hide();var d=$.parseJSON(a);FileBrowser.showResult(d.infomsg,d.errmsg)});this.$itemsBox=$("#itemsList");$("#itemsList li a").live("keypress",function(a){if(a.keyCode==38||a.keyCode==40||a.keyCode==13||a.keyCode==46||a.keyCode==45){a.preventDefault();switch(a.keyCode){case 38:$(this).parent("li").prev().children("a").trigger("click",a.shiftKey);break;case 40:$(this).parent("li").next().children("a").trigger("click",a.shiftKey);break;case 13:$(this).trigger("dblclick",false);break;case 45:$(this).parent("li").next().children("a").trigger("click",true);break;case 46:$("#buttonDelete").click();break;default:alert(a.keyCode);break}}});$("#itemsList li a").live("click",function(e,g){e.preventDefault();$(this).focus();if(typeof(g)!="undefined"){e.ctrlKey=g}if(typeof(e.shiftKey)=="undefined"){e.shiftKey=false}if(e.ctrlKey){if($.isMarkedItem(this)){$(this).unmarkItem()}else{$(this).markItem()}}else{if(e.shiftKey){var d=FileBrowser.getSelected();var f=$("li").index(d.parent("li"));var c=$("li").index($(this).parent("li"));var a=FileBrowser.getAllItems();if(f<=c){for(var b=f;b<=c;b++){$(a[b]).markItem()}}else{for(var h=f;h>=c;h--){$(a[h]).markItem()}}}else{FileBrowser.getMarked().unmarkItem();$(this).markItem()}}FileBrowser.getSelected().unselectItem();$(this).selectItem();FileBrowser.showData($(this));return});$("#itemsList li a").live("dblclick",function(a,b){if($(this).data("type")=="dir"||$(this).data("type")=="dot"){FileBrowser.load($(this).data("path")+$(this).data("name")+"/")}else{FileBrowserDialogue.submitFile()}return});this.load();FileBrowser.showTip()},showResult:function(a,b){if(b.length>0){$("#log").prepend("<br />").prepend($("<span></span>").text(b.join(", ")).addClass("errmsg"))}if(a.length>0){$("#log").prepend("<br />").prepend($("<span></span>").text(a.join(", ")).addClass("msg"))}},logMsg:function(a){},clearLog:function(){$("#log").html("")},showData:function(q){var n=150;var f=q.data();var c=$("#infoBox");var i=$("#fileActions").html("<p>Žádné nástroje nejsou k dispozici.</p>");c.html("");$("#currentFile").text(f.name);if(f.type=="dir"){if(f.access.write==true){var b=$("<p></p>");var j=$("<select></select>").attr({name:"users",size:6,multiple:true});var d=FileBrowser.getSelected();FileBrowser.request("getUsers",{path:d.data("path"),name:d.data("name")},function(r){var h=$("<option></option>");$.each(r.users,function(s){var t=h.clone();t.attr({value:this.id,selected:this.selected}).text(this.name);j.append(t)})});b.append("<strong>Povolení zápisu pro:</strong><br />");b.append(j);b.append("<br />");b.append('<input name="chenge_perms" value="Přiřadit" type="button" onClick="FileBrowser.setDirPerms()" />');i.html(b)}}else{if(f.type=="file"){if(f.info.type=="image"){var a=$("<img />");var o=f.info.dimension.w;var l=f.info.dimension.h;if(f.info.dimension.w>n||f.info.dimension.h>n){if(f.info.dimension.w>f.info.dimension.h){l=f.info.dimension.h/f.info.dimension.w*n;o=n}else{o=f.info.dimension.w/f.info.dimension.h*n;l=n}}var g=new Date;a.attr("src",FileBrowser.baseUrl+f.realpath+"?t="+(g.getTime()/1000).toString()).css({width:o,height:l-5});c.append($("<p></p>").addClass("imgprev-box").html(a));var p=$("<p></p>").addClass("file-info").html("Rozměry:<br/>"+f.info.dimension.w+"x"+f.info.dimension.h+" px<br />Velikost:<br/>"+$.getItemSize(f.info.size)+"<br />");if(f.info.dimension.w>imageBigSizeW){p.append("<br /><strong>Obázek je příliš velký pro vložení do stránky!!!. Doporučujeme zmenšit alespoň na "+imageBigSizeW+"x"+imageBigSizeH+" px.</strong><br />")}c.append(p);var b=$("<p></p>");b.append("<strong>Vytvořit zmenšeninu:</strong><br />");b.append('<input type="text" size="5" maxlength="5" name="img_w" value="0" />&times;<input type="text" size="5" maxlength="5" name="img_h" value="0" /> px <input type="button" name="img_resize" value="Vytvořit" onClick="FileBrowser.imageResize()" /><br /><input type="checkbox" name="img_ratio" checked="checked" /> Zachovat poměr <input type="checkbox" name="img_crop" /> Ořezat<hr />');var m=$('input[name="img_w"]',b).val(f.info.dimension.w).data("origsize",f.info.dimension.w);var e=$('input[name="img_h"]',b).val(f.info.dimension.h).data("origsize",f.info.dimension.h);m.change(function(){if($('input[name="img_ratio"]',b).is(":checked")){$('input[name="img_h"]',b).val(Math.round(parseInt($(this).val())/parseInt($('input[name="img_w"]',b).data("origsize"))*parseInt($('input[name="img_h"]',b).data("origsize"))))}});e.change(function(){if($('input[name="img_ratio"]',b).is(":checked")){$('input[name="img_w"]',b).val(Math.round(parseInt($(this).val())/parseInt($('input[name="img_h"]',b).data("origsize"))*$('input[name="img_w"]',b).data("origsize")))}});b.append("<strong>Otočit doprava:</strong><br />");b.append('<select name="img_degree"><option value="90">90°</option><option value="180">180°</option><option value="270">270°</option></select>&nbsp;<input type="button" name="img_rotate" value="Otočit" onClick="FileBrowser.imageRotate()" /><hr />');b.append("<strong>Vytvořit obrázky v systémové velikosti:</strong><br />");b.append("Velký:"+imageBigSizeW+"x"+imageBigSizeH+" Malý:"+imageSmallSizeW+"x"+imageSmallSizeH+'&nbsp;<input type="button" name="img_system_sizes" value="Vytvořit" onClick="FileBrowser.imageSystemResize()" /><br /><input type="checkbox" name="img_createdirs" checked="checked" /> Zařadit do adresářů (small, medium) <hr />');i.html(b)}else{if(f.info.type=="flash"){c.html("");var o=f.info.dimension.w;var l=f.info.dimension.h;if(f.info.dimension.w>n||f.info.dimension.h>n){if(f.info.dimension.w>f.info.dimension.h){l=f.info.dimension.h/f.info.dimension.w*n;o=n}else{o=f.info.dimension.w/f.info.dimension.h*n;l=n}}var k=$("<p></p>").addClass("imgprev-box");k.html('<object width="'+o+'" height="'+l+'"><param name="movie" value="'+FileBrowser.baseUrl+f.realpath+'"><embed src="'+FileBrowser.baseUrl+f.realpath+'" width="'+o+'" height="'+l+'"></embed></object>');c.append(k);c.append($("<p></p>").addClass("file-info").html("Rozměry:<br/>"+f.info.dimension.w+"x"+f.info.dimension.h+" px<br />Velikost:<br/>"+$.getItemSize(f.info.size)+"<br />"))}else{c.html($("<p></p>").addClass("file-info").html("Velikost:<br/>"+$.getItemSize(f.info.size)+"<br />"))}}}}},timer:null,showWorking:function(){FileBrowser.timer=setTimeout(function(){$("#working").show()},500)},hideWorking:function(){clearTimeout(FileBrowser.timer);$("#working").hide()},getFileTypes:function(){var c=Array();if(this.listType=="image"){c=Array("jpg","jpeg","png","gif","bmp","wmf")}else{if(this.listType=="media"){c=Array("swf","mp4","m4v","ogv","mov","flv","rm","qt","avi","mp3","ogg","wma","wav")}}if(c.length!=0){var a=c.length;for(var b=0;b<a;b++){c[b]="*."+c[b];c[b+a]=c[b].toUpperCase()}return c.join(";")}return"*.*"},request:function(c,a,d,b){$.ajax({type:"POST",data:a,url:window.location.toString().replace("browser.php",c+".php"),cache:false,success:function(e){if(typeof(d)=="function"){d.call(this,e)}if(e.infomsg.length>0||e.errmsg.length>0){FileBrowser.showResult(e.infomsg,e.errmsg)}},error:function(){FileBrowser.showResult([],["Chyba při komunikaci se serverem. Zkuste znovu."])},complete:function(){}})},getSelected:function(){return this.$itemsBox.find("li a.item-selected")},getMarked:function(){return this.$itemsBox.find("li a.item-marked")},getAllItems:function(){return this.$itemsBox.find("li a")},load:function(a){if(typeof(a)=="undefined"){a=this.currentDir}FileBrowser.showWorking();this.request("getitems",{path:a,type:FileBrowser.listType},function(d){FileBrowser.hideWorking();var b=FileBrowser.getSelected().data("realpath");FileBrowser.$itemsBox.html("");if(typeof(d.items)!="undefined"){$.each(d.items,function(){var e=$("<a>");e.append(this.name).attr({title:this.name,href:this.realpath}).data(this);if(this.type=="dir"){e.addClass("dir");if(this.info.type=="home"){e.addClass("dir-home")}else{if(this.info.type=="public"){e.addClass("dir-pub")}}if(this.access.write==true){e.addClass("dir-writable")}}else{if(this.type=="dot"){e.addClass("dir");e.addClass("dir-up")}else{e.addClass("file").css("background-image","url("+FileBrowser.baseUrl+FileBrowser.iconsDir+this.info.type+"_icon.png)");if(this.access.write==true){e.addClass("file-writable")}}}FileBrowser.$itemsBox.append($("<li></li>").append(e))});FileBrowser.writable=d.writable;if(FileBrowser.currentDir==d.current&&typeof(b)!="undefined"){var c=FileBrowser.$itemsBox.find('a[href="'+b+'"]');if(c.length>0){c.click()}else{FileBrowser.$itemsBox.children("li:first a").click()}}else{FileBrowser.$itemsBox.children("li:first a").click();FileBrowser.storePath(d.current)}FileBrowser.currentDir=d.current;$("#currentPath").text(d.current)}else{FileBrowser.goPublic()}})},goHome:function(){this.currentDir="home";this.load()},goPublic:function(){this.currentDir="/public/";this.load()},storePath:function(c){var b=cookieName+"="+escape(c)+";";var a=new Date();a.setTime(a.getTime()+30*60*1000);b+="expires="+a.toGMTString()+";";b+="path=/;";document.cookie=b},loadPath:function(){if(document.cookie.length>0&&FileBrowser.currentDir==null){var b=document.cookie.indexOf(cookieName+"=");if(b!=-1){b=b+cookieName.length+1;var a=document.cookie.indexOf(";",b);if(a==-1){a=document.cookie.length}return unescape(document.cookie.substring(b,a))}}return baseLoadPath},createDir:function(){if(this.writable==false){alert("Nemáte dostatečná práva pro vytvoření adresáře");return false}var a=prompt("Zadejte název nového adresáře");if(a==null||a==""){return false}FileBrowser.request("createdir",{path:this.currentDir,newname:a},function(){FileBrowser.load()});return true},deleteItems:function(){if(confirm("Opravdu smazat označené položky?")==false){return}this.showWorking();var a=new Array;this.getMarked().each(function(){a.push(new Array($(this).data("path"),$(this).data("name")))});if(a.length>0){this.request("delete",{items:a},function(){FileBrowser.hideWorking();FileBrowser.load()})}return},renameItems:function(){var b=new Array;var a="";this.getMarked().each(function(){var c=$(this).data();if(c.type!="dot"&&c.access.write==true){a=window.prompt("Přejmenovat na",c.name);if(a!=null&&a!=""&&a!=c.name){b.push(new Array(c.path,c.name,a))}}});if(b.length>0){FileBrowser.showWorking();this.request("rename",{items:b},function(){FileBrowser.hideWorking();FileBrowser.load()})}},clipboardCut:function(){this.clipboardClear();FileBrowser.clipboard.cut=true;this.getMarked().each(function(){if($(this).data("type")!="dot"){$(this).addClass("item-cut");FileBrowser.clipboard.items.push($(this).data())}});this.clipboardShow();return},clipboardCopy:function(){this.clipboardClear();FileBrowser.clipboard.cut=false;this.getMarked().each(function(){if($(this).data("type")!="dot"){$(this).addClass("item-copy");FileBrowser.clipboard.items.push($(this).data())}});this.clipboardShow();return},clipboardPaste:function(){this.showWorking();var a=new Array;$.each(this.clipboard.items,function(){var b=this;a.push(new Array(b.path,b.name))});this.request("copy",{target:this.currentDir,items:a,move:this.clipboard.cut},function(){FileBrowser.clipboardClear();FileBrowser.hideWorking();FileBrowser.load()})},clipboardClear:function(){this.clipboard.cut=false;this.clipboard.items=new Array;FileBrowser.getMarked().removeClass("item-cut").removeClass("item-copy");$("#clipboard").html("")},clipboardShow:function(){var a=$("#clipboard");$.each(FileBrowser.clipboard.items,function(){a.append("<li><span>"+this.realpath+"</span></li>")})},imageResize:function(){FileBrowser.showWorking();var b=Array;if($('input[name="apply_all"]').is(":checked")){b=FileBrowser.getMarked()}else{b=FileBrowser.getSelected()}var a=new Array;b.each(function(){a.push($(this).data("name"))});FileBrowser.request("imageResized",{path:FileBrowser.currentDir,file:a,ratio:$('input[name="img_ratio"]').is(":checked"),newW:$('input[name="img_w"]').val(),newH:$('input[name="img_h"]').val(),crop:$('input[name="img_crop"]').is(":checked")},function(){FileBrowser.hideWorking();FileBrowser.load()})},imageSystemResize:function(){FileBrowser.showWorking();var b=Array;if($('input[name="apply_all"]').is(":checked")){b=FileBrowser.getMarked()}else{b=FileBrowser.getSelected()}var a=new Array;b.each(function(){a.push($(this).data("name"))});FileBrowser.request("createSystemImages",{path:FileBrowser.currentDir,file:a,createdirs:$('input[name="img_createdirs"]').is(":checked")},function(){FileBrowser.hideWorking();FileBrowser.load()})},imageRotate:function(){FileBrowser.showWorking();var b=Array;if($('input[name="apply_all"]').is(":checked")){b=FileBrowser.getMarked()}else{b=FileBrowser.getSelected()}var a=new Array;b.each(function(){a.push($(this).data("name"))});FileBrowser.request("imageRotate",{path:FileBrowser.currentDir,file:a,degree:$('select[name="img_degree"]').val()},function(){FileBrowser.hideWorking();FileBrowser.load()})},setDirPerms:function(){var a=$('select[name="users"]').val();FileBrowser.getMarked().each(function(){if($(this).data("type")=="dir"){FileBrowser.request("storeDirPerms",{path:$(this).data("path"),name:$(this).data("name"),users:a})}})},showTip:function(){$("#log").html($("<span></span>").addClass("tip").text("TIP: "+tips[Math.floor(Math.random()*tips.length)]))}};