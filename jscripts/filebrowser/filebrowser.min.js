var FileBrowserDialogue={listType:null,win:null,category:0,init:function(){FileBrowser.listType=tinyMCEPopup.getWindowArg("listType");FileBrowserDialogue.win=tinyMCEPopup.getWindowArg("window");FileBrowserDialogue.category=tinyMCEPopup.getWindowArg("cat");var a=tinyMCEPopup.getWindowArg("url");if(a!=""){var b=/data(\/.*\/)[a-z0-9._-]+/i;var c=a.match(b);if(c){FileBrowser.currentDir=c[1]}}FileBrowser.init()},submitFile:function(){FileBrowserDialogue.win.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=FileBrowser.getSelected().data("realpath");if(typeof FileBrowserDialogue.win.ImageDialog!="undefined"){if(FileBrowserDialogue.win.ImageDialog.getImageData)FileBrowserDialogue.win.ImageDialog.getImageData();if(FileBrowserDialogue.win.ImageDialog.showPreviewImage)FileBrowserDialogue.win.ImageDialog.showPreviewImage(FileBrowser.getSelected().data("realpath"))}tinyMCEPopup.close()}};var FileBrowser={cmsPluginUrl:null,currentDir:null,baseUrl:null,iconsDir:"images/files/",uploadLink:null,sessionId:null,listType:null,uploadFilesPosParams:null,$itemsBox:null,$dirCnt:null,writable:false,clipboard:{cut:false,items:new Array},extendJQ:function(){$.fn.selectItem=function(){$(this).addClass("item-selected")};$.fn.markItem=function(){$(this).addClass("item-marked")};$.fn.unselectItem=function(){$(this).removeClass("item-selected")};$.fn.unmarkItem=function(){$(this).removeClass("item-marked")};$.fn.clipCutItem=function(){$(this).addClass("item-cut")};$.fn.clipUncutItem=function(){$(this).removeClass("item-cut")};$.extend({isSelectedItem:function(a){return $(a).hasClass("item-selected")},isMarkedItem:function(a){return $(a).hasClass("item-marked")},getItemSize:function(a){var a=parseFloat(a);if(a>1048576){return Number(a/1048576).toFixed(2).toString()+" MB"}else if(a>1024){return Number(a/1024).toFixed(2).toString()+" KB"}else{return a.toString()+" B"}}})},init:function(){this.extendJQ();this.cmsPluginUrl=window.location.toString().replace("browser.php","jscripts/tinymce/");if(this.currentDir==null){this.currentDir=this.loadPath()}this.uploadFilesPosParams={sessionid:FileBrowser.sessionId,upload_send:"send",path:FileBrowser.currentDir,type:FileBrowser.listType};$(".swfupload-control").swfupload({upload_url:FileBrowser.uploadLink,file_post_name:"upload_file",post_params:FileBrowser.uploadFilesPosParams,file_size_limit:maxUploadFileSize/1024,file_types:FileBrowser.getFileTypes(),file_types_description:"files",file_upload_limit:150,file_queue_limit:0,button_image_url:FileBrowser.baseUrl+"/images/upload_cs.png",button_placeholder_id:"spanButtonPlaceholder",button_width:61,button_height:22,button_window_mode:SWFUpload.WINDOW_MODE.OPAQUE,flash_url:FileBrowser.baseUrl+"/jscripts/swfupload/swfupload.swf",flash9_url:FileBrowser.baseUrl+"/jscripts/swfupload/swfupload_fp9.swf"});$(".swfupload-control").bind("fileQueued",function(a,b){FileBrowser.uploadFilesPosParams.path=FileBrowser.currentDir;$(this).swfupload("setPostParams",FileBrowser.uploadFilesPosParams);$(this).swfupload("startUpload")}).bind("uploadComplete",function(a,b){$(this).swfupload("startUpload")}).bind("uploadStart",function(a,b){$("#uploading-files").show()}).bind("fileQueueError",function(a,b,c,d){FileBrowser.showResult([],["Velikost souboru "+b.name+" je větší než povolený limit"])}).bind("uploadSuccess",function(a,b,c){FileBrowser.load();$("#uploading-files").hide();var d=$.parseJSON(c);FileBrowser.showResult(d.infomsg,d.errmsg)});this.$itemsBox=$("#itemsList");$("#itemsList li a").live("keypress",function(a){if(a.keyCode==38||a.keyCode==40||a.keyCode==13||a.keyCode==46||a.keyCode==45){a.preventDefault();switch(a.keyCode){case 38:$(this).parent("li").prev().children("a").trigger("click",a.shiftKey);break;case 40:$(this).parent("li").next().children("a").trigger("click",a.shiftKey);break;case 13:$(this).trigger("dblclick",false);break;case 45:$(this).parent("li").next().children("a").trigger("click",true);break;case 46:$("#buttonDelete").click();break;default:alert(a.keyCode);break}}});$("#itemsList li a").live("click",function(a,b){a.preventDefault();$(this).focus();if(typeof b!="undefined")a.ctrlKey=b;if(typeof a.shiftKey=="undefined")a.shiftKey=false;if(a.ctrlKey){if($.isMarkedItem(this)){$(this).unmarkItem()}else{$(this).markItem()}}else if(a.shiftKey){var c=FileBrowser.getSelected();var d=$("li").index(c.parent("li"));var e=$("li").index($(this).parent("li"));var f=FileBrowser.getAllItems();if(d<=e){for(var g=d;g<=e;g++){$(f[g]).markItem()}}else{for(var h=d;h>=e;h--){$(f[h]).markItem()}}}else{FileBrowser.getMarked().unmarkItem();$(this).markItem()}FileBrowser.getSelected().unselectItem();$(this).selectItem();FileBrowser.showData($(this));return});$("#itemsList li a").live("dblclick",function(a,b){if($(this).data("type")=="dir"||$(this).data("type")=="dot"){FileBrowser.load($(this).data("path")+$(this).data("name")+"/")}else{FileBrowserDialogue.submitFile()}return});this.load();FileBrowser.showTip()},showResult:function(a,b){if(b.length>0){$("#log").prepend("<br />").prepend($("<span></span>").text(b.join(", ")).addClass("errmsg"))}if(a.length>0){$("#log").prepend("<br />").prepend($("<span></span>").text(a.join(", ")).addClass("msg"))}},logMsg:function(a){},clearLog:function(){$("#log").html("")},showData:function(a){var b=150;var c=a.data();var d=$("#infoBox");var e=$("#fileActions").html("<p>Žádné nástroje nejsou k dispozici.</p>");d.html("");$("#currentFile").text(c.name);if(c.type=="dir"){if(c.access.write==true){var f=$("<p></p>");var g=$("<select></select>").attr({name:"users",size:6,multiple:true});var h=FileBrowser.getSelected();FileBrowser.request("getUsers",{path:h.data("path"),name:h.data("name")},function(a){var b=$("<option></option>");$.each(a.users,function(a){var c=b.clone();c.attr({value:this.id,selected:this.selected}).text(this.name);g.append(c)})});f.append("<strong>Povolení zápisu pro:</strong><br />");f.append(g);f.append("<br />");f.append('<input name="chenge_perms" value="Přiřadit" type="button" onClick="FileBrowser.setDirPerms()" />');e.html(f)}}else if(c.type=="file"){if(c.info.type=="image"){var i=$("<img />");var j=c.info.dimension.w;var k=c.info.dimension.h;if(c.info.dimension.w>b||c.info.dimension.h>b){if(c.info.dimension.w>c.info.dimension.h){k=c.info.dimension.h/c.info.dimension.w*b;j=b}else{j=c.info.dimension.w/c.info.dimension.h*b;k=b}}var l=new Date;i.attr("src",FileBrowser.baseUrl+c.realpath+"?t="+(l.getTime()/1e3).toString()).css({width:j,height:k-5});d.append($("<p></p>").addClass("imgprev-box").html(i));var m=$("<p></p>").addClass("file-info").html("Rozměry:<br/>"+c.info.dimension.w+"x"+c.info.dimension.h+" px<br />"+"Velikost:<br/>"+$.getItemSize(c.info.size)+"<br />");if(c.info.dimension.w>imageBigSizeW){m.append("<br /><strong>Obázek je příliš velký pro vložení do stránky!!!. Doporučujeme zmenšit alespoň na "+imageBigSizeW+"x"+imageBigSizeH+" px.</strong><br />")}d.append(m);var f=$("<p></p>");f.append("<strong>Vytvořit zmenšeninu:</strong><br />");f.append('<input type="text" size="5" maxlength="5" name="img_w" value="0" />×'+'<input type="text" size="5" maxlength="5" name="img_h" value="0" /> px '+'<input type="button" name="img_resize" value="Vytvořit" onClick="FileBrowser.imageResize()" /><br />'+'<input type="checkbox" name="img_ratio" checked="checked" /> Zachovat poměr '+'<input type="checkbox" name="img_crop" /> Ořezat'+"<hr />");var n=$('input[name="img_w"]',f).val(c.info.dimension.w).data("origsize",c.info.dimension.w);var o=$('input[name="img_h"]',f).val(c.info.dimension.h).data("origsize",c.info.dimension.h);n.change(function(){if($('input[name="img_ratio"]',f).is(":checked")){$('input[name="img_h"]',f).val(Math.round(parseInt($(this).val())/parseInt($('input[name="img_w"]',f).data("origsize"))*parseInt($('input[name="img_h"]',f).data("origsize"))))}});o.change(function(){if($('input[name="img_ratio"]',f).is(":checked")){$('input[name="img_w"]',f).val(Math.round(parseInt($(this).val())/parseInt($('input[name="img_h"]',f).data("origsize"))*$('input[name="img_w"]',f).data("origsize")))}});f.append("<strong>Otočit doprava:</strong><br />");f.append('<select name="img_degree">'+'<option value="90">90°</option>'+'<option value="180">180°</option>'+'<option value="270">270°</option>'+"</select> "+'<input type="button" name="img_rotate" value="Otočit" onClick="FileBrowser.imageRotate()" />'+"<hr />");f.append("<strong>Vytvořit obrázky v systémové velikosti:</strong><br />");f.append("Velký:"+imageBigSizeW+"x"+imageBigSizeH+" Malý:"+imageSmallSizeW+"x"+imageSmallSizeH+' <input type="button" name="img_system_sizes" value="Vytvořit" onClick="FileBrowser.imageSystemResize()" /><br />'+'<input type="checkbox" name="img_createdirs" checked="checked" /> Zařadit do adresářů (small, medium) '+"<hr />");e.html(f)}else if(c.info.type=="flash"){d.html("");var j=c.info.dimension.w;var k=c.info.dimension.h;if(c.info.dimension.w>b||c.info.dimension.h>b){if(c.info.dimension.w>c.info.dimension.h){k=c.info.dimension.h/c.info.dimension.w*b;j=b}else{j=c.info.dimension.w/c.info.dimension.h*b;k=b}}var p=$("<p></p>").addClass("imgprev-box");p.html('<object width="'+j+'" height="'+k+'">'+'<param name="movie" value="'+FileBrowser.baseUrl+c.realpath+'">'+'<embed src="'+FileBrowser.baseUrl+c.realpath+'" width="'+j+'" height="'+k+'">'+"</embed></object>");d.append(p);d.append($("<p></p>").addClass("file-info").html("Rozměry:<br/>"+c.info.dimension.w+"x"+c.info.dimension.h+" px<br />"+"Velikost:<br/>"+$.getItemSize(c.info.size)+"<br />"))}else{d.html($("<p></p>").addClass("file-info").html("Velikost:<br/>"+$.getItemSize(c.info.size)+"<br />"))}}},timer:null,showWorking:function(){FileBrowser.timer=setTimeout(function(){$("#working").show()},500)},hideWorking:function(){clearTimeout(FileBrowser.timer);$("#working").hide()},getFileTypes:function(){var a=Array();if(this.listType=="image"){a=Array("jpg","jpeg","png")}else if(this.listType=="media"){a=Array("swf","mp4","m4v","ogv","mov","flv","rm","qt","avi","mp3","ogg","wma","wav")}if(a.length!=0){var b=a.length;for(var c=0;c<b;c++){a[c]="*."+a[c];a[c+b]=a[c].toUpperCase()}return a.join(";")}return"*.*"},request:function(a,b,c,d){$.ajax({type:"POST",data:b,url:window.location.toString().replace("browser.php",a+".php"),cache:false,success:function(a){if(typeof c=="function"){c.call(this,a)}if(a.infomsg.length>0||a.errmsg.length>0){FileBrowser.showResult(a.infomsg,a.errmsg)}},error:function(){FileBrowser.showResult([],["Chyba při komunikaci se serverem. Zkuste znovu."])},complete:function(){}})},getSelected:function(){return this.$itemsBox.find("li a.item-selected")},getMarked:function(){return this.$itemsBox.find("li a.item-marked")},getAllItems:function(){return this.$itemsBox.find("li a")},load:function(a){if(typeof a=="undefined")a=this.currentDir;FileBrowser.showWorking();this.request("getitems",{path:a,type:FileBrowser.listType},function(a){FileBrowser.hideWorking();var b=FileBrowser.getSelected().data("realpath");FileBrowser.$itemsBox.html("");if(typeof a.items!="undefined"){$.each(a.items,function(){var a=$("<a>");a.append(this.name).attr({title:this.name,href:this.realpath}).data(this);if(this.type=="dir"){a.addClass("dir");if(this.info.type=="home"){a.addClass("dir-home")}else if(this.info.type=="public"){a.addClass("dir-pub")}if(this.access.write==true)a.addClass("dir-writable")}else if(this.type=="dot"){a.addClass("dir");a.addClass("dir-up")}else{a.addClass("file").css("background-image","url("+FileBrowser.baseUrl+FileBrowser.iconsDir+this.info.type+"_icon.png)");if(this.access.write==true)a.addClass("file-writable")}FileBrowser.$itemsBox.append($("<li></li>").append(a))});FileBrowser.writable=a.writable;if(FileBrowser.currentDir==a.current&&typeof b!="undefined"){var c=FileBrowser.$itemsBox.find('a[href="'+b+'"]');if(c.length>0){c.click()}else{FileBrowser.$itemsBox.children("li:first a").click()}}else{FileBrowser.$itemsBox.children("li:first a").click();FileBrowser.storePath(a.current)}FileBrowser.currentDir=a.current;$("#currentPath").text(a.current)}else{FileBrowser.goPublic()}})},goHome:function(){this.currentDir="home";this.load()},goPublic:function(){this.currentDir="/public/";this.load()},storePath:function(a){var b=cookieName+"="+escape(a)+";";var c=new Date;c.setTime(c.getTime()+30*60*1e3);b+="expires="+c.toGMTString()+";";b+="path=/;";document.cookie=b},loadPath:function(){if(document.cookie.length>0&&FileBrowser.currentDir==null){var a=document.cookie.indexOf(cookieName+"=");if(a!=-1){a=a+cookieName.length+1;var b=document.cookie.indexOf(";",a);if(b==-1)b=document.cookie.length;return unescape(document.cookie.substring(a,b))}}alert(baseLoadPath);return baseLoadPath},createDir:function(){if(this.writable==false){alert("Nemáte dostatečná práva pro vytvoření adresáře");return false}var a=prompt("Zadejte název nového adresáře");if(a==null||a=="")return false;FileBrowser.request("createdir",{path:this.currentDir,newname:a},function(){FileBrowser.load()});return true},deleteItems:function(){if(confirm("Opravdu smazat označené položky?")==false)return;this.showWorking();var a=new Array;this.getMarked().each(function(){a.push(new Array($(this).data("path"),$(this).data("name")))});if(a.length>0){this.request("delete",{items:a},function(){FileBrowser.hideWorking();FileBrowser.load()})}return},renameItems:function(){var a=new Array;var b="";this.getMarked().each(function(){var c=$(this).data();if(c.type!="dot"&&c.access.write==true){b=window.prompt("Přejmenovat na",c.name);if(b!=null&&b!=""&&b!=c.name){a.push(new Array(c.path,c.name,b))}}});if(a.length>0){FileBrowser.showWorking();this.request("rename",{items:a},function(){FileBrowser.hideWorking();FileBrowser.load()})}},clipboardCut:function(){this.clipboardClear();FileBrowser.clipboard.cut=true;this.getMarked().each(function(){if($(this).data("type")!="dot"){$(this).addClass("item-cut");FileBrowser.clipboard.items.push($(this).data())}});this.clipboardShow();return},clipboardCopy:function(){this.clipboardClear();FileBrowser.clipboard.cut=false;this.getMarked().each(function(){if($(this).data("type")!="dot"){$(this).addClass("item-copy");FileBrowser.clipboard.items.push($(this).data())}});this.clipboardShow();return},clipboardPaste:function(){this.showWorking();var a=new Array;$.each(this.clipboard.items,function(){var b=this;a.push(new Array(b.path,b.name))});this.request("copy",{target:this.currentDir,items:a,move:this.clipboard.cut},function(){FileBrowser.clipboardClear();FileBrowser.hideWorking();FileBrowser.load()})},clipboardClear:function(){this.clipboard.cut=false;this.clipboard.items=new Array;FileBrowser.getMarked().removeClass("item-cut").removeClass("item-copy");$("#clipboard").html("")},clipboardShow:function(){var a=$("#clipboard");$.each(FileBrowser.clipboard.items,function(){a.append("<li><span>"+this.realpath+"</span></li>")})},imageResize:function(){FileBrowser.showWorking();var a=Array;if($('input[name="apply_all"]').is(":checked")){a=FileBrowser.getMarked()}else{a=FileBrowser.getSelected()}var b=new Array;a.each(function(){b.push($(this).data("name"))});FileBrowser.request("imageResized",{path:FileBrowser.currentDir,file:b,ratio:$('input[name="img_ratio"]').is(":checked"),newW:$('input[name="img_w"]').val(),newH:$('input[name="img_h"]').val(),crop:$('input[name="img_crop"]').is(":checked")},function(){FileBrowser.hideWorking();FileBrowser.load()})},imageSystemResize:function(){FileBrowser.showWorking();var a=Array;if($('input[name="apply_all"]').is(":checked")){a=FileBrowser.getMarked()}else{a=FileBrowser.getSelected()}var b=new Array;a.each(function(){b.push($(this).data("name"))});FileBrowser.request("createSystemImages",{path:FileBrowser.currentDir,file:b,createdirs:$('input[name="img_createdirs"]').is(":checked")},function(){FileBrowser.hideWorking();FileBrowser.load()})},imageRotate:function(){FileBrowser.showWorking();var a=Array;if($('input[name="apply_all"]').is(":checked")){a=FileBrowser.getMarked()}else{a=FileBrowser.getSelected()}var b=new Array;a.each(function(){b.push($(this).data("name"))});FileBrowser.request("imageRotate",{path:FileBrowser.currentDir,file:b,degree:$('select[name="img_degree"]').val()},function(){FileBrowser.hideWorking();FileBrowser.load()})},setDirPerms:function(){var a=$('select[name="users"]').val();FileBrowser.getMarked().each(function(){if($(this).data("type")=="dir"){FileBrowser.request("storeDirPerms",{path:$(this).data("path"),name:$(this).data("name"),users:a})}})},showTip:function(){$("#log").html($("<span></span>").addClass("tip").text("TIP: "+tips[Math.floor(Math.random()*tips.length)]))}}