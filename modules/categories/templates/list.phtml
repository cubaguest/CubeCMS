<?php 
$this->addCssFile("style.css");
$this->addJsPlugin(new JsPlugin_JQuery());
$this->addJsPlugin(new JsPlugin_JQueryCSS());
$this->addJsPlugin(new JsPlugin_TreeTable());

define('SECTION_EDTI_LABEL', $this->tr('Upravit'));
define('SECTION_REMOVE_LABEL', $this->tr('Smazat'));
define('SECTION_SETTINGS_LABEL', $this->tr('Upravit parametry'));
define('SECTION_MOVEUP_LABEL', $this->tr('Nahoru'));
define('SECTION_MOVEDOWN_LABEL', $this->tr('Dolu'));
define('SECTION_GOTO_CAT_LABEL', $this->tr('Přejít'));
define('SECTION_SHOW_DETAIL_LABEL', $this->tr('Zobrazit detail'));
define('SECTION_MODULE_LABEL', $this->tr('Modul'));
define('SECTION_LABEL_LABEL', $this->tr('Popisek'));
define('SECTION_IND_PANELS_LABEL', $this->tr('Individuální panely'));
define('SECTION_YES_LABEL', $this->tr('Ano'));
define('SECTION_NO_LABEL', $this->tr('Ne'));
define('SECTION_MODULE_DATADIR', $this->tr('Datový adresář'));
define('SECTION_RIGHTS', $this->tr('Výchozí práva'));
define('SECTION_TITLE', $this->tr('Popis'));
define('SECTION_DESC', $this->tr('Popis vyhledávače'));
define('SECTION_VISIBILITY', $this->tr('Viditelné'));
define('SECTION_VISIBILITY_ALL', $this->tr('Všem'));
define('SECTION_VISIBILITY_HIDDEN', $this->tr('Nikomu'));
define('SECTION_VISIBILITY_WHEN_LOG', $this->tr('Pouze přihlášeným'));
define('SECTION_VISIBILITY_WHEN_NOT_LOG', $this->tr('Pouze nepřihlášeným'));
define('SECTION_VISIBILITY_WHEN_ADMIN', $this->tr('Pouze administrátorům'));

// funkce pro render menu
function vveSectionsRenderFunc($menuArr, $link) {
   $link2 = clone $link;
   $link3 = clone $link;
   //   print ("<ul>\n");
   $first = true;
   $count = $menuArr->count();
   $cycle = 0;
   //   $level = $menuArr->getLevel();
   foreach ($menuArr as $key => $item) {
      $cycle++;
      $class = null;
      if($item->getParentId() != 0){// pokud není kořen
         $class = 'child-of-node-'.$item->getParentId();
      }
      ?><tr id="node-<?php echo $item->getId();?>" class="ui-widget-header list-item <?php echo $class;?>">
      <td class="cat-first-coll">
<!--         <div class="category-header">-->
            <span class="sec"><?php echo $item?></span>
            <?php echo langsImages($item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_URLKEY});
               if($item->getCatObj()->haveFeed()){?><a href="<?php echo $link3->clear()->category($item->getCatObj()->getUrlKey())->file(Url_Request::URL_FILE_RSS);?>" title="rss feed"><img src="<?php echo Url_Request::getBaseWebDir()?>images/icons/rss-icon.png" alt="feed icon" height="12" /></a><?php }?>&nbsp;ID:<?php echo $item->getId()?>
            <a href="" class="button-show-detail" title="<?php echo SECTION_SHOW_DETAIL_LABEL?>">detail</a>&nbsp;
            <a href="<?php echo $link3->clear()->lang()->category($item->getCatObj()->getUrlKey())?>" title="<?php echo SECTION_GOTO_CAT_LABEL?>"><?php echo SECTION_GOTO_CAT_LABEL?></a>
<!--      </div>-->
      <div class="category-params">
         <input type="hidden" name="id_cat" value="<?php echo $item->getCatObj()->getId();?>" />
         <table>
            <tr>
               <th><?php echo SECTION_MODULE_LABEL?>:</th>
               <td><?php echo $item->getCatObj()->getModule()->getName()?></td>
            </tr>
            <tr>
               <th><?php echo SECTION_IND_PANELS_LABEL?>:</th>
               <td>
                  <input type="checkbox" name="change_ind_panels" <?php if($item->getCatObj()->isIndividualPanels() == true) echo 'checked="checked"';?> />
               </td>
            </tr>
            <tr>
               <th><?php echo SECTION_VISIBILITY?>:</th>
               <td><?php 
               switch ($item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_VISIBILITY}) {
                  case Model_Category::VISIBILITY_HIDDEN:
                     echo SECTION_VISIBILITY_HIDDEN;
                     break;
                  case Model_Category::VISIBILITY_WHEN_ADMIN:
                     echo SECTION_VISIBILITY_WHEN_ADMIN;
                     break;
                  case Model_Category::VISIBILITY_WHEN_LOGIN:
                     echo SECTION_VISIBILITY_WHEN_LOG;
                     break;
                  case Model_Category::VISIBILITY_WHEN_NOT_LOGIN:
                     echo SECTION_VISIBILITY_WHEN_NOT_LOG;
                     break;
                  case Model_Category::VISIBILITY_ALL:
                  default:
                     echo SECTION_VISIBILITY_ALL;
                     break;
               }
                  ?></td>
            </tr>
            <tr>
               <th><?php echo SECTION_MODULE_DATADIR?>:</th>
               <td><?php echo $item->getCatObj()->getModule()->getDataDir(true)?></td>
            </tr>
            <tr>
               <th><?php echo SECTION_RIGHTS?>:</th>
               <td><?php echo $item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_DEF_RIGHT};?></td>
            </tr>
            <tr>
               <th><?php echo SECTION_TITLE?>:</th>
               <td><?php echo $item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_CAT_ALT};?></td>
            </tr>
            <tr>
               <th><?php echo SECTION_DESC?>:</th>
               <td><?php echo $item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_DESCRIPTION};?></td>
            </tr>
            <tr>
               <th>Url:</th>
               <td><?php 
                  foreach ($item->getCatObj()->getCatDataObj()->{Model_Category::COLUMN_URLKEY} as $lang => $urlkey){
                     if($urlkey == null) continue;
                     if($lang != Locales::getDefaultLang()) $link3->lang($lang); // default language needn't have definition in URL
                     $l = (string)$link3->clear()->category($urlkey);
                     echo '<a href="'.$l.'" title="'.SECTION_GOTO_CAT_LABEL.'">';
                     echo '<img src="images/langs/small/'.$lang.'.png" alt="'.$lang.'" class="lang-image" />&nbsp;';
                     echo $l;
                     echo '</a>';
                     echo '<br />';
                  }
               ?></td>
            </tr>
         </table>
      </div>
         </td><td width="110" valign="top">
      <form method="post" action="<?php echo $link2->route('settings',array('categoryid' => $item->getId()))?>" style="display:inline;">
         <input type="image" src="<?php echo vve_get_tpl_file('icons/cog_edit.png', VVE_TPL_FILE_IMAGE)?>"
                value="edit" name="category_settings" title="<?php echo SECTION_SETTINGS_LABEL?>" />
      </form>
      <form method="post" action="<?php echo $link2->route('edit',array('categoryid' => $item->getId()))?>" style="display:inline;">
         <input type="image" src="<?php echo vve_get_tpl_file('icons/application_edit.png', VVE_TPL_FILE_IMAGE)?>"
                value="edit" name="category_edit" title="<?php echo SECTION_EDTI_LABEL?>" />
      </form>
      <form method="post" action="<?php echo $link?>" style="display:inline;" onsubmit="return submitRemoveCat('<?php echo $item;?>')">
         <input type="hidden" value="<?php echo $item->getId()?>" name="category_id" />
         <input type="image" src="<?php echo vve_get_tpl_file('icons/application_delete.png', VVE_TPL_FILE_IMAGE)?>"
                value="remove" name="category_remove" title="<?php echo SECTION_REMOVE_LABEL?>" />
      </form>
            <?php if(!$first) {?>
      <form method="post" action="<?php echo $link?>" style="display:inline;">
         <input type="hidden" value="<?php echo $item->getId()?>" name="item_id" />
         <input type="hidden" value="up" name="item_move_to" />
         <input type="image" src="<?php echo vve_get_tpl_file('icons/go-up.png', VVE_TPL_FILE_IMAGE)?>"
                value="edit" name="item_move" title="<?php echo SECTION_MOVEUP_LABEL?>" />
      </form>
            <?php }
            if($cycle < $count) {?>
      <form method="post" action="<?php echo $link?>" style="display:inline;">
         <input type="hidden" value="<?php echo $item->getId()?>" name="item_id" />
         <input type="hidden" value="down" name="item_move_to" />
         <input type="image" src="<?php echo vve_get_tpl_file('icons/go-down.png', VVE_TPL_FILE_IMAGE)?>"
                value="edit" name="item_move" title="<?php echo SECTION_MOVEDOWN_LABEL?>" />
      </form>
            <?php }?>
   </td>
</tr>
      <?php 
      if(!$item->isEmpty()) {
         vveSectionsRenderFunc($item, $link);
      }
      $first = false;
   }
}

echo $this->toolbox;
?>
<h1><?php echo $this->tr("Struktura stránek")?></h1>
<?php echo $this->includeTpl('navigation.phtml');?>
<div class="main-content-detail">
   <p><?php echo $this->tr('Ve struktuře jsou zobrazeny také zkryté položky.');?></p>
   <?php //sekce
   $typeClass = 'mainStruct';
   $id = 'categories-table';
   if($this->isMainMenu != true) {
      $id = 'admin-categories-table';
      $typeClass = 'adminStruct';
      echo '<p><strong>'.$this->tr("Pozor úprava administračního menu může ovlivnit chování celých stránek!").'</strong></p>';
   }
   ?>
   <hr />
   <div id="sections" class="<?php echo $typeClass?>">
      <table id="<?php echo $id?>" style="width: 98%">
         <?php if($this->structure != null){
            echo vveSectionsRenderFunc($this->structure, $this->link());
         }?>
      </table>
   </div>
   <br />
   <br />
   <?php 
   ?>
   <script type="text/javascript">
      /* <![CDATA[ */
      $('#<?php echo $id?>').treeTable({
         clickableNodeNames : false,
         indent: 15
      });

      function submitRemoveCat(msg){
         return confirm('<?php echo $this->tr('Opravdu smazat kategorii: ')?>'+msg+'?');
      }

      $('a.button-show-detail').click(function(){
         var $div = $(this).parent('td').children('div.category-params');
         $div.toggle();
         if($div.is(':hidden')){
            $(this).parent('td').parent('tr').removeClass('ui-widget-content');
         } else {
            $(this).parent('td').parent('tr').addClass('ui-widget-content');
         }
//         $(this).parent('td').children('div.category-params').toggle(function(){
//         }, function(){
//            alert('hide');
//         });
         return false;
      });
      $('span.sec').click(function(){$(this).prev('span').click();});
      $('input[name=change_ind_panels]').change(function(){
         var sendData = {
            enabled : false,
            idc : $(this).parents('div.category-params').find('input[name=id_cat]').val()
         };

         if($(this).is(":checked")){
            sendData.enabled = true;
         }
         $.ajax({
            type: "POST", url: "<?php echo $this->link()->route("changeIndPanels")?>",
            data: sendData,
            success: function(msg){
//               alert( "Data Saved: " + msg );
            }
         })

      });
      /* ]]> */
   </script>
</div>

