<?
if(Template::browser()->isMobile()){
   $this->includeFile("tpl://list_mobile.phtml");
   return;
}

$this->addCssFile("style.css");
$this->includeTpl('sortLabel.phtml');
$h1 = $this->category()->getName().$this->sortText;
echo $this->toolbox;
?>
<h1><?$this->includeFile('tpl://engine:headline/icon.phtml'); echo $h1;?></h1>
<div class="main-content-list">
   <?=$this->includeTpl('sort.phtml')?>
   <?if((string)$this->text->{Text_Model::COLUMN_TEXT} != null AND !isset($_GET[Component_Scroll::GET_PARAM]) AND !isset($_GET[Articles_Controller::PARAM_SORT])){?>
   <div class="main-content-text">
      <?=$this->filter((string)$this->text->{Text_Model::COLUMN_TEXT}, array('anchors','emoticons'))?>
      <hr class="reseter" />
   </div>   
   <?}?>
   <div class="main-content-list-records">
   <?if(!empty ($this->articles)) {
      foreach ($this->articles as $article) {
         $showClass = $public = null;
         if($article->{Articles_Model::COLUMN_CONCEPT} == true){
            $showClass = 'main-content-concept';
            $public = $this->tr('Koncept').'&nbsp;';
         }
         $editTime = new DateTime($article->{Articles_Model::COLUMN_ADD_TIME});
         // find image
         $image = null;
         $w = 150;
         $h = 100;
         $c = true;
         if($article->{Articles_Model::COLUMN_TITLE_IMAGE} != null){
            $imgSrc = vve_image_cacher(vve_tpl_art_title_image($article->{Articles_Model::COLUMN_TITLE_IMAGE}), $w, $h, $c );
            $imgAlt = htmlspecialchars($article->{Articles_Model::COLUMN_NAME});
            $image = "<img src=\"$imgSrc\" alt=\"$imgAlt\" class=\"title-image image-left\" />";
         } else {
            $doc = new DOMDocument();
            @$doc->loadHTML('<?xml encoding="UTF-8">' .$article->{Articles_Model::COLUMN_TEXT});
            $xml = simplexml_import_dom($doc); // just to make xpath more simple
            $images = $xml->xpath('//img');
            if(!empty ($images) && isset ($images[0])){
               $imgSrc = vve_image_cacher($images[0]['src'], $w, $h, $c );
               $imgAlt = htmlspecialchars($images[0]['alt'] != null ? $images[0]['alt'] : $article->{Articles_Model::COLUMN_NAME});
               $image = "<img src=\"$imgSrc\" alt=\"$imgAlt\" class=\"title-image image-left\" />";
            }
         }
         ?>
      <div class="main-content-list-record <?=$showClass?>">
         <h2><a href="<?=$this->link()->route('detail', array('urlkey' => $article->{Articles_Model::COLUMN_URLKEY}))?>"
               title="<?=htmlspecialchars($article->{Articles_Model::COLUMN_NAME})?>"><?=htmlspecialchars($article->{Articles_Model::COLUMN_NAME})?>&nbsp;
               <span class="font-small">
               <?=strftime("%x %X", $editTime->format("U"))?> - <?=$article->{Model_Users::COLUMN_USERNAME}?></span>
            </a><span class="font-small"><?=$public?></span><?
            if($this->category()->getRights()->isControll()){
               echo langsImages($article->{Articles_Model::COLUMN_URLKEY});
            }
            ?>
         </h2>
         <? if($image != null) {?><div class="main-content-list-record-image"><?=$image?></div><?}?>
         <?if((string)$article->{Articles_Model::COLUMN_ANNOTATION} != null){?>
            <div class="main-content-list-record-annotation"><?echo $article->{Articles_Model::COLUMN_ANNOTATION};?></div>
         <?} else {?>
            <div class="main-content-list-record-text"><?echo vve_tpl_truncate(strip_tags($article->{Articles_Model::COLUMN_TEXT}), 640);?></div>
         <?}?>
         <hr class="reseter" />
         <div class="main-content-showed"><?=$this->tr('Zobrazeno')?>:&nbsp;<?=$article->{Articles_Model::COLUMN_SHOWED}?>&times;</div>
         <div class="main-content-link-more">
            <a href="<?=$this->link()->route('detail', array('urlkey' => $article->{Articles_Model::COLUMN_URLKEY}))?>"
               title="<?=$this->tr("více o").' '.$article->{Articles_Model::COLUMN_NAME}?>">[&nbsp;<?=$this->tr("více")?>&nbsp;]</a>
         </div>
         <hr class="reseter" />
      </div>
      <?}?>
   <?
      echo $this->scrollComp;
   } else {
      echo ($this->tr('Není vložen žádný článek'));
   }
   ?>
   </div>
   <?
   // rss ikony
   $feeds = new Component_Feed();
   $feeds->setConfig('feedLink', $this->link()->clear());
   echo $feeds;
   ?>
</div>
