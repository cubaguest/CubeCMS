<?
$this->addPageTitle($this->_('Vytvořit e-mail'));
$this->addCssFile('style.css');
?>
<h1><?=$this->category()->getName().' - '.$this->_('vytvořit e-mail')?></h1>
<?=$this->includeTpl('navigation.phtml');?>
<div id="mails-send-mail-form">
   <?
   $jQ = new JsPlugin_JQuery();
   $jQ->addUITabs();
   $jQ->addUIAutoComplete();
   $this->addJsPlugin($jQ);
   ?>
   <?
   $this->form->html()->setAttrib('id', 'mail-send-form');
   echo $this->form->renderStart(); ?>
   <table>
      <tr>
         <td>
            <? echo $this->form->recipients->label() ?><br />
            <? $this->form->recipients->html()->setAttrib('cols', 80)->setAttrib('rows', 5);
            echo $this->form->recipients->controll(); ?>
            <? echo $this->form->recipients->sublabel() ?>
            <br />
         </td>
      </tr>
      <tr>
         <td>
            <label><?=$this->_('Přidat e-mail z') ?>:</label>
            <div id="address-tabs">
               <ul>
                  <li><a href="#tabs-mails-addressbook"><?=$this->_('Adresáře') ?></a></li>
                  <li><a href="#tabs-mails-users"><?=$this->_('Uživatelů systému') ?></a></li>
                  <?if($this->mailsNewsLetter !== null AND !empty ($this->mailsNewsLetter)){?>
                     <li><a href="#tabs-mails-newsletter"><?=$this->_('NewsLetteru') ?></a></li>
                  <?}?>
                  <?if($this->mailsGuestbook !== null AND !empty ($this->mailsGuestbook)){?>
                     <li><a href="#tabs-mails-guestbook"><?=$this->_('Knihy návštěv') ?></a></li>
                  <?}?>
               </ul>
               <div id="tabs-mails-addressbook">
                  <label for="mails-addressbook"><?=$this->_('Všechny adresy v adresáři')?>:</label><br />
                  <select name="mails-addressbook" class="mail-selected" id="mails-addressbook"
                          size="6" multiple="multiple">
                     <? foreach ($this->mailsAddressBook as $mail) {
                        $str = null;
                        if ($mail->{Mails_Model_Addressbook::COLUMN_SURNAME} != null) {
                           $str .= '"'.$mail->{Mails_Model_Addressbook::COLUMN_NAME}
                           ." ".$mail->{Mails_Model_Addressbook::COLUMN_SURNAME}.'" ';
                        }
                        $str .= '<'.$mail->{Mails_Model_Addressbook::COLUMN_MAIL}.'>';
                        $str = htmlspecialchars($str);
                        ?><option value="<?=$str?>"><?=$str?></option><?
                     }?>
                  </select><br />
                  <input type="button" value="<?=$this->_('Přidat')?>" class="button-add" />
                  <input type="button" value="<?=$this->_('Přidat všechny')?>" class="button-add-all" /><br />
                  <br />
                  <label for="mails-addressbook-groups"><?=$this->_('Adresy ze skupiny')?>:</label><br />
                  <select name="mails-addressbook-groups" id="mails-addressbook-groups">
                     <?foreach ($this->mailsGroups as $grp) {
                        ?><option value="<?=$grp->{Mails_Model_Groups::COLUMN_ID}?>"><?=$grp->{Mails_Model_Groups::COLUMN_NAME}?></option><?
                     }?>
                  </select>
                  <input type="button" value="<?=$this->_('Přidat')?>" name="button-add-group" /><br />
               </div>
               <div id="tabs-mails-users">
                  <?foreach ($this->mailsUsers as $gname => $grp) {
                     $gnameAscii = vve_to_ascii($gname);
                     ?>
                  <div>
                  <label for="mails-users-grp-<?=$gnameAscii?>"><?=$this->_('Skupina').':&nbsp;'.$gname?></label><br />
                  <select name="mails-users" class="mail-selected" id="mails-users-grp-<?=$gnameAscii?>">
                     <?foreach ($grp as $mail) {
                        if($mail->{Model_Users::COLUMN_MAIL} == null) continue;
                        $m = explode(';', $mail->{Model_Users::COLUMN_MAIL});
                        $str = null;
                        if ($mail->{Model_Users::COLUMN_SURNAME} != null) {
                           $str .= '"'.$mail->{Model_Users::COLUMN_NAME}
                           ." ".$mail->{Model_Users::COLUMN_SURNAME}.'" ';
                        } 
//                           echo $mail->{Model_Users::COLUMN_USERNAME};
                        $str .= '<'.$m[0].'>';
                        $str = htmlspecialchars($str);
                        ?><option value="<?=$str;?>"><?=$str;?></option><?
                     }?>
                  </select>
                  <input type="button" value="<?=$this->_('Přidat')?>" class="button-add" />
                  <input type="button" value="<?=$this->_('Přidat všechny')?>" class="button-add-all" />
                  </div>
                  <?}?>
               </div>
                  <?if($this->mailsNewsLetter !== null AND !empty ($this->mailsNewsLetter)){?>
               <div id="tabs-mails-newsletter">
                  <select name="mails-newsletters" class="mail-selected" id="mails-newsletters"
                          size="6" multiple="multiple">
                     <?foreach ($this->mailsNewsLetter as $mail) {
                        $str = htmlspecialchars('<'.$mail->{NewsLetter_Model_Mails::COLUMN_MAIL}.'>');
                        ?><option value="<?=$str?>"><?=$str;?></option><?
                     }?>
                  </select>
                  <input type="button" value="<?=$this->_('Přidat')?>" class="button-add" />
                  <input type="button" value="<?=$this->_('Přidat všechny')?>" class="button-add-all" />
               </div>
                  <?}?>
                  <?if($this->mailsGuestbook !== null AND !empty ($this->mailsGuestbook)){?>
               <div id="tabs-mails-guestbook">
                  <select name="mails-guestbook" class="mail-selected" id="mails-guestbook"
                          size="6" multiple="multiple">
                     <?foreach ($this->mailsGuestbook as $mail) {
                        $str = htmlspecialchars('"'.$mail->{GuestBook_Model_Detail::COL_NICK}.'" '
                        .'<'.$mail->{GuestBook_Model_Detail::COL_EMAIL}.'>');
                        ?><option value="<?=$str;?>"><?=$str;?></option>
                     <?}?>
                  </select>
                  <input type="button" value="<?=$this->_('Přidat')?>" class="button-add" />
                  <input type="button" value="<?=$this->_('Přidat všechny')?>" class="button-add-all" />
               </div>
                  <?}?>
            </div>
            <br />
         </td>
      </tr>
      <tr>
         <td>
            <? echo $this->form->subject->label() ?><br />
            <? $this->form->subject->html()->setAttrib('size', 60);
                     echo $this->form->subject->controll(); ?><br />
                     <br />
                  </td>
               </tr>
               <tr>
                  <td>
            <? echo $this->form->text->label() ?>&nbsp;
                  <?=$this->_('editor') ?>:&nbsp;<a href="<?=$this->link() ?>#disableEditor"
                      onclick="toggleEditor('sendmail_text_1');"
                      title="<?=$this->_('vypnout/zapnout editor') ?>"><?=$this->_('OFF/ON') ?></a>
            <br />
            <?
            $this->form->text->html()->setAttrib('cols', 90)->setAttrib('rows', 40)->addClass('mceEditorSimple');
            echo $this->form->text->controll(); ?>
            <br />
         </td>
      </tr>
      <tr>
         <td align="">
            <? echo $this->form->send->controll() ?>
         </td>
      </tr>
      <tr>
         <td>
            <?
            echo $this->form->sendBatch->label();
            echo $this->form->sendBatch->controll();
            ?>
            <br />
            <br />
         </td>
      </tr>
      <tr>
         <td>
            <?
            echo $this->form->sendQueue->label();
            echo $this->form->sendQueue->controll();
            echo $this->form->sendQueue->subLabel();
            ?>
            <br />
            <br />
         </td>
      </tr>
      <tr>
         <td>
            <?
            echo $this->form->file->label();
            echo $this->form->file->controll();
            ?>
            <br />
         </td>
      </tr>
   </table>
   <? echo $this->form->renderEnd(); ?>
</div>
<script type="text/javascript">
   /* <![CDATA[ */
   function toggleEditor(id) {
      if (!tinyMCE.get(id)) tinyMCE.execCommand('mceAddControl', false, id);
      else tinyMCE.execCommand('mceRemoveControl', false, id);
      return false;
   }
   var $recBox = null;
   function addMail(mailstr){
      var curStr = $recBox.val();
      if(mailstr != '' && mailstr != null && curStr.search(mailstr) == -1){
         $recBox.val(curStr+mailstr.replace('&lt;', '<').replace('&gt;', '>')+', ');
      }
   }
   // find last string
   function getLastStr(str){
      var lastSpace = str.lastIndexOf(' ');
      var lastDot = str.lastIndexOf(',');
      if(lastSpace != -1 || lastDot != -1){
         if(lastSpace > lastDot){
            str = str.slice(lastSpace+1);
         } else {
            str = str.slice(lastDot+1);
         }
      }
      return str;
   }

   $(function() {
      $recBox = $('textarea[name=sendmail_recipients]'); // init of box
      $("#address-tabs").tabs({collapsible: true,selected: -1});
      $('input.button-add-all').click(function(){
         $(this).parent('div').children('select.mail-selected').children('option').each(function() {
            addMail($(this).val());
         });
      });
      $('input.button-add').click(function(){
         $(this).parent('div').children('select').children('option:selected').each(function(){
            addMail($(this).val());
         });
      });
      $('select.mail-selected option').dblclick(function(){
         addMail($(this).val());
      });
      $('input[name=button-add-group]').click(function(){
         $.ajax({
            type: "GET",
            cache : false,
            url:'<?=$this->link()->route('addressList');?>',
            data : ({idgrp : $('select[name=mails-addressbook-groups]').val()}),
            success: function(data){
               $.each(data.rows, function(index, value) {
                  var str = '';
                  if(value.cell[2] != null && value.cell[2] != ''){
                     str += '"'+value.cell[1]+' '+value.cell[2]+'" ';
                  }
                  str += '<'+value.cell[0]+'>';
                  addMail(str);
               });
            }
         });
      });
      var sterm = '';
      $recBox.autocomplete({
			minLength: 1,
			source: function(request, response) {
            sterm = getLastStr(request.term);
				$.getJSON("<?=$this->link()->route('searchMail')?>", {q:sterm},
            function(data){
               var list = new Array();
               $.each(data.mails, function(){
                  var str = '';
                  if(this.surname != null || this.surname == ''){
                     str += '"'+this.name+' '+this.surname+'" ';
                  }
                  str += '&lt;'+this.mail+'&gt;';
                  list.push(str)
               });
               response(list);
            }
            );
			},
         search: function(event, ui) {
            if(getLastStr($recBox.val()).replace(/\s/g,"") == ""){
               return false;
            }
         },
			focus: function() {return false;},
			select: function(event, ui) {
            var reg = new RegExp(sterm+'$');
            $recBox.val($recBox.val().replace(reg,''));
            addMail(ui.item.value);
				return false;
			}
		});

      // Odeslání pomocí ajaxu
//      $('#mail-send-form').submit(function(){
//         var mailsStr = $('textarea[name=sendmail_recipients]').val();
//         if(mailsStr.length == 0){
//            alert('Nebyla zadána žádná e-mailová adresa');
//         }
//         // regexp pro výběr emailů
//         var mailRegex = new RegExp(/(?:(?:"[\w-\s]+")|(?:[\w-]+(?:\.[\w-]+)*)|(?:"[\w-\s]+")(?:[\w-]+(?:\.[\w-]+)*))(?:@(?:(?:[\w-]+\.)*\w[\w-]{0,66})\.(?:[a-z]{2,6}(?:?:\.[a-z]{2})?))|(?:@\[?(?:(?:25[0-5]\.|2[0-4][0-9]\.|1[0-9]{2}\.|[0-9]{1,2}\.))(?:(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){2}(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\]?)/gi);
//
//
//         return false;
//
//      });

   });
   /* ]]> */
</script>
<br />



