<?
$this->addJsPlugin(new JsPlugin_SWFUpload());
$this->addJsPlugin(new JsPlugin_PiroBox());
$this->addJsPlugin(new JsPlugin_JQueryCSS());
$this->addFile("css://photogalery:style.less");
?>
<h1><?
   printf($this->tr('Úprava obrázků přiřazených ke "%s"'), $this->name == null ? $this->category()->getName() : $this->name);
?></h1>
<?$this->includeFile('tpl://photogalery:addimage.phtml')?>
<div class="ui-widget ui-widget-imageslist">
   <h2 class="ui-widget-header"><?=$this->tr('Seznam uložených obrázků')?></h2>
   <div class="">
      <form method="post" action="<?=$this->link()?>">
         <fieldset class="fieldset-alt">
         <div class="list-controlls ui-widget-header">
            <p class="images-counter-wrap">
               <?=$this->tr('Celkem obrázků:')?>
               <span class="images-counter"><?=count($this->images)?></span>
            </p>
            <input id="button-sort-images" type="button" value="<?=$this->tr('Řadit obrázky')?>"
                   title="<?=$this->tr('upravit řazení obrázků')?>" onclick="window.location.href = '<?=$this->link()->route('sortphotos')->param('b','e')?>'" />
            <input id="button-check-all-images" type="button" value="<?=$this->tr('Změnit označení')?>" title="<?=$this->tr('Změnit označení pro smazání')?>" />
            <?
            echo $this->editForm->save->controll();
            ?>
         </div>
         <div id="edit-photos-list" class="ui-widget-content">
            <table class="full-width">
            <?$step = 0;
            foreach ($this->images as $image) {
               $step++;?>
               <tr id="file-<?=  str_replace('.', '_', $image->{PhotoGalery_Model_Images::COLUMN_FILE})?>"
                   class="ui-state-default">
               <td class="photo-preview" style="width: 75px">
                  <a href="<?=$this->category()->getModule()->getDataDir(true).$this->websubdir.Photogalery_Controller::DIR_MEDIUM.URL_SEPARATOR
               .$image->{PhotoGalery_Model_Images::COLUMN_FILE}?>" class="pirobox_gall" title="<?=$this->tr('Zobrazit náhled')?>"><img
                        src="<?=$this->category()->getModule()->getDataDir(true).$this->websubdir.Photogalery_Controller::DIR_SMALL.URL_SEPARATOR
               .$image->{PhotoGalery_Model_Images::COLUMN_FILE}.'?time='.time()?>" alt="<?=$image->{PhotoGalery_Model_Images::COLUMN_FILE}?>" width="70"
                  /></a>
                  <br />
                  <?
                     $this->editForm->delete->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     $this->editForm->delete->setValues(false);
                     echo ($this->editForm->delete->label());
                     echo ($this->editForm->delete->controll()->addClass('button-check-delete-image'));//->setAttrib('onclick', "if(this.checked == true)return confirm('Smazat?')"));
                     echo ($this->editForm->delete->scripts());?>
               </td>
               <td valign="top" style="padding-right:10px;">
                     <?
                     $this->editForm->name->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     $this->editForm->name->setValues(array($image->{PhotoGalery_Model_Images::COLUMN_ID} =>
                             $image->{PhotoGalery_Model_Images::COLUMN_NAME}));
                     echo ($this->editForm->name->label()."<br />");
                     echo ($this->editForm->name->labelLangs());
                     echo ($this->editForm->name->controll());
                     echo ($this->editForm->name->scripts());
                     ?>
                  <p>
                     <?
                     $this->editForm->ord->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     $this->editForm->ord->setValues($image->{PhotoGalery_Model_Images::COLUMN_ORDER});
                     echo ($this->editForm->ord->label());
                     $this->editForm->ord->html()->setAttrib('size', 5);
                     echo ($this->editForm->ord->controll());
                     echo ($this->editForm->ord->scripts());
                     ?>
                     <?
                     $this->editForm->rotate->setLabel('<img src="images/icons/arrow_rotate_anticlockwise.png" />');
                     $this->editForm->rotate->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     echo ($this->editForm->rotate->label());
                     echo ($this->editForm->rotate->controll());?>   
                  </p>
                  <p>
                     <a href="<?=$this->link()->route('editphoto',array('id' => $image->{PhotoGalery_Model_Images::COLUMN_ID}))?>"
                        title="<?=$this->tr('Upravit miniaturu')?>" class="form-button"><?=$this->tr('Upravit miniaturu')?></a>
                  </p>
               </td>
               <td valign="top">
                     <?
                     $this->editForm->desc->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     $this->editForm->desc->setValues(array($image->{PhotoGalery_Model_Images::COLUMN_ID} =>
                             $image->{PhotoGalery_Model_Images::COLUMN_DESC}));
                     echo ($this->editForm->desc->label()."<br />");
                     echo ($this->editForm->desc->labelLangs());
                     echo ($this->editForm->desc->controll());
                     echo ($this->editForm->desc->scripts());
                     ?>
                     <?
                     $this->editForm->id->setDimensional($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     $this->editForm->id->setValues($image->{PhotoGalery_Model_Images::COLUMN_ID});
                     echo ($this->editForm->id->controll());?>
                  <a href="<?=$this->link()?>#delete-image" title="<?=$this->tr('Smazat obrázek')?>"
                     class="button-delete-image" data-id="<?=$image->{PhotoGalery_Model_Images::COLUMN_ID}?>"
                          ><span class="ui-icon ui-icon-closethick"> </span></a>
               </td>
            </tr>
            <?}?>
         </table>
         </div>
         <div class="list-controlls ui-widget-header">
            <?
            echo ($this->editForm->goBack->label());
            echo ($this->editForm->goBack->controll());
            echo $this->editForm->save->controll();
            ?>
         </div>
         <?=$this->editForm->scripts()?>
         </fieldset>
      </form>
   </div>
   <script type="text/javascript">
      $(document).ready(function(){
         $('a.button-delete-image').live("click",function(e){
            var $link = $(this);
            e.preventDefault();
            if(confirm('<?=$this->tr('Smazat obrázek?')?>')){
               $.ajax({
                  type: "POST",
                  data : {id : $link.data("id")},
                  url: '<?=$this->link()->route('deletephoto')?>',
                  success: function(data) {
                     if(data.errmsg && data.errmsg.length > 0){
                        CubeCMS.Msg.show(data);
                     } else if(data.infomsg && data.infomsg.length > 0){
                        $link.parents('tr').animate({opacity : 0}, 600, function(){
                           $(this).remove();
                        });
                     }
                  }
               });
            }
         });
      });
   </script>
</div>